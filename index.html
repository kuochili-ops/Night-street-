<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>NightST 霓虹啟動特效版</title>
    <style>
        :root { --accent: #00ff88; --bg: #0a0a0a; }
        body { font-family: sans-serif; background: var(--bg); color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { max-width: 800px; width: 100%; background: #1a1a1a; padding: 25px; border-radius: 12px; }
        .view-port { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        canvas, video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #mainVideo { visibility: hidden; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input { padding: 12px; border-radius: 6px; border: 1px solid #444; background: #222; color: #fff; }
        .btn { padding: 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; background: var(--accent); color: #000; grid-column: span 2; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:var(--accent)">NightST Neon Starter</h2>
    <div class="view-port">
        <video id="mainVideo" src="NightST.MP4" playsinline muted loop></video>
        <canvas id="compCanvas"></canvas>
    </div>

    <div class="controls">
        <input type="text" id="signText" placeholder="輸入招牌文字..." style="grid-column: span 2;">
        <input type="color" id="textColor" value="#00ff88">
        <button class="btn" id="runBtn">啟動並觀看特效</button>
    </div>
</div>

<script>
/**
 * FlipBoard 模組：增加燈管啟動點滅邏輯
 */
const FlipBoardModule = (() => {
    return {
        // 生成文字層，並根據 time 決定是否點滅
        generateDynamicTexture: (text, w, h, color, time) => {
            const cvs = document.createElement('canvas');
            cvs.width = w; cvs.height = h;
            const x = cvs.getContext('2d');
            
            // 基礎底色
            x.fillStyle = "rgba(10, 15, 10, 0.95)";
            x.fillRect(0, 0, w, h);

            // --- 起動特效邏輯 ---
            let opacity = 1;
            // 在 2.5s 到 3.2s 之間進行隨機點滅
            if (time > 2.5 && time < 3.2) {
                // 利用 Math.random 模擬不穩定電流
                opacity = Math.random() > 0.4 ? 1 : 0.1; 
            }

            x.globalAlpha = opacity;
            x.fillStyle = color;
            x.font = `bold ${h * 0.18}px sans-serif`;
            x.textAlign = "center";
            x.textBaseline = "middle";
            x.shadowColor = color;
            x.shadowBlur = opacity > 0.5 ? 25 : 5; // 點亮時才有強發光
            x.fillText(text, w / 2, h * 0.46);
            
            return cvs;
        },
        isGreen: (r, g, b) => (g > 50 && g > r * 1.3 && g > b * 1.1)
    };
})();

const video = document.getElementById('mainVideo');
const canvas = document.getElementById('compCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const runBtn = document.getElementById('runBtn');

function render() {
    if (video.paused || video.ended) return;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (video.currentTime > 2.5 && document.getElementById('signText').value) {
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const pixels = frame.data;
        
        // 每一影格即時生成包含點滅狀態的貼圖 (確保流暢)
        const currentOverlay = FlipBoardModule.generateDynamicTexture(
            document.getElementById('signText').value, 
            canvas.width, canvas.height, 
            document.getElementById('textColor').value,
            video.currentTime
        );
        const texData = currentOverlay.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data;

        for (let i = 0; i < pixels.length; i += 4) {
            if (FlipBoardModule.isGreen(pixels[i], pixels[i+1], pixels[i+2])) {
                pixels[i] = texData[i];
                pixels[i+1] = texData[i+1];
                pixels[i+2] = texData[i+2];
            }
        }
        ctx.putImageData(frame, 0, 0);
    }
    
    requestAnimationFrame(render);
}

runBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;
    video.currentTime = 0;
    video.play();
    render();
});
</script>
</body>
</html>
